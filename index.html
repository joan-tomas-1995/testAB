<!DOCTYPE html>
<html lang="es">

  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mi Tienda Online</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        margin: 0;
        padding: 0;
      }

      header {
        background-color: #333;
        color: white;
        padding: 1rem;
        text-align: center;
      }

      .container {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 1rem;
        padding: 1rem;
      }

      .product {
        border: 1px solid #ddd;
        border-radius: 8px;
        padding: 1rem;
        text-align: center;
      }

      .product img {
        max-width: 100%;
        height: 150px;
        object-fit: cover;
      }

      .product h2 {
        font-size: 1.2rem;
        margin: 0.5rem 0;
      }

      .product p {
        color: #28a745;
        font-weight: bold;
      }

      .product button {
        padding: 0.5rem 1rem;
        background-color: #007bff;
        color: white;
        border: none;
        cursor: pointer;
        border-radius: 4px;
      }

      .product button:hover {
        background-color: #0056b3;
      }
    </style>
    <script>

      // Inicializar SDK
      window.TestAB = {
        experiments: [],
        visitorId: '571acf10-e61f-4d86-98ec-1bc79740aec0',
        debug: true,
        supabaseUrl: 'https://aynriqgxrddbxrwlxqlu.supabase.co',
        supabaseKey: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImF5bnJpcWd4cmRkYnhyd2x4cWx1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDYwNTM1OTAsImV4cCI6MjA2MTYyOTU5MH0.PiWqRIsART84mavWoG944qfb82JEyXbAFN2huR-sK40',
        apiKey: '571acf10-e61f-4d86-98ec-1bc79740aec0',

        init: function () {
          console.log('Inicializando SDK con config:', {
            apiKey: this.apiKey,
            supabaseUrl: this.supabaseUrl,
            supabaseKey: this.supabaseKey
          });

          // Ocultar la página inicialmente
          document.body.style.opacity = '0';

          // Cargar experimentos
          this.loadExperiments();
        },

        // Cargar experimentos activos
        loadExperiments: async function () {
          console.log('Cargando experimentos...');
          try {
            const response = await fetch(
              this.supabaseUrl + '/rest/v1/experiments?select=*&status=eq.running',
              {
                headers: {
                  'apikey': this.supabaseKey,
                  'Authorization': 'Bearer ' + this.supabaseKey
                }
              }
            );

            console.log('Respuesta de experimentos:', response);

            if (!response.ok) {
              throw new Error('Error en la respuesta de la API');
            }

            const data = await response.json();
            console.log('Datos de experimentos:', data);

            if (!Array.isArray(data)) {
              console.warn('No se encontraron experimentos activos');
              window.testabShow();
              return;
            }

            // Mapear los campos de snake_case a camelCase
            const experiments = data.map(exp => ({
              ...exp,
              targetUrl: exp.target_url,
              trafficAllocation: exp.traffic_allocation,
              variants: exp.variants || []
            }));

            // Guardar experimentos
            this.experiments = experiments;

            // Aplicar cada experimento
            experiments.forEach(experiment => {
              if (this.shouldApplyExperiment(experiment)) {
                this.applyExperiment(experiment);
              }
            });

            window.testabShow();
          } catch (error) {
            console.error('Error cargando experimentos:', error);
            window.testabShow();
          }
        },

        // Verificar si el experimento debe aplicarse
        shouldApplyExperiment: function (experiment) {
          if (!experiment) return false;

          // Verificar URL
          if (experiment.targetUrl && !window.location.href.includes(experiment.targetUrl)) {
            return false;
          }

          // Verificar asignación de tráfico
          if (Math.random() * 100 > experiment.trafficAllocation) {
            return false;
          }

          return true;
        },

        // Aplicar un experimento
        applyExperiment: function (experiment) {
          if (!experiment || !experiment.variants) return;

          const variant = this.getVariant(experiment);

          if (variant && variant.changes) {
            variant.changes.forEach(change => {
              const elements = document.querySelectorAll(change.selector);
              elements.forEach(element => {
                if (change.type === 'hide') {
                  element.style.display = 'none';
                } else if (change.type === 'show') {
                  element.style.display = '';
                } else if (change.type === 'modify' && change.value) {
                  element.style[change.selector] = change.value;
                }
              });
            });
          }
        },

        // Obtener variante para un experimento
        getVariant: function (experiment) {
          if (!experiment || !experiment.variants || !Array.isArray(experiment.variants)) {
            return null;
          }

          const hash = this.hashString(this.visitorId + experiment.id);
          const totalWeight = experiment.variants.reduce((sum, v) => sum + v.traffic, 0);
          let weightSum = 0;

          for (const variant of experiment.variants) {
            weightSum += variant.traffic;
            if (hash % totalWeight < weightSum) {
              return variant;
            }
          }

          return experiment.variants[0];
        },

        // Rastrear eventos
        track: async function (eventName, properties = {}) {
          const event = {
            name: eventName,
            properties: {
              ...properties,
              visitorId: this.visitorId,
              userId: this.apiKey,
              timestamp: new Date().toISOString(),
              url: window.location.href
            }
          };

          if (this.debug) {
            console.log('Evento registrado:', event);
          }

          try {
            const response = await fetch(this.supabaseUrl + '/rest/v1/events', {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
                'apikey': this.supabaseKey,
                'Authorization': 'Bearer ' + this.supabaseKey
              },
              body: JSON.stringify(event)
            });

            if (!response.ok) {
              throw new Error('Error al guardar el evento');
            }
          } catch (error) {
            console.error('Error guardando evento:', error);
          }
        },

        // Función auxiliar para hash
        hashString: function (str) {
          let hash = 0;
          for (let i = 0; i < str.length; i++) {
            const char = str.charCodeAt(i);
            hash = ((hash << 5) - hash) + char;
            hash = hash & hash;
          }
          return Math.abs(hash);
        }
      };

      // Inicializar SDK
      window.TestAB.init();

    </script>





  </head>

  <body>
    <header>
      <h1>Mi Tienda Online</h1>
    </header>

    <main class="container">
      <div class="product" id="product1">
        <img src="https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcS2JxxysV3Jya743eJeNU0HVZTC5vM-wuPWoA&s"
          alt="Producto 1">
        <h2>Producto 1</h2>
        <p>€19.99</p>
        <button>Comprar</button>
      </div>
      <div class="product">
        <img src="https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcQTq3sXNqrqSocjjGgCieZ9MLaM2ttBseG7SA&s"
          alt="Producto 2">
        <h2>Producto 2</h2>
        <p>€24.99</p>
        <button>Comprar</button>
      </div>
      <div class="product">
        <img
          src="https://5.imimg.com/data5/ECOM/Default/2024/7/439128150/JO/EO/LD/141264671/h9b6fd5c1e98a4bd2b1dfe25a11d89b67p-500x500.webp"
          alt="Producto 3">
        <h2>Producto 3</h2>
        <p>€15.50</p>
        <button>Comprar</button>
      </div>
    </main>
  </body>

</html>